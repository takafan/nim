<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>nim</title>
<script src="./jquery-1.8.2.min.js"></script>
<script>
$(function(){
  if(!("WebSocket" in window)) {
    $('#chat1').text("WebSocket NOT supported by your Browser!");
    return;
  }

  var url;
  var s = getParameterByName('s');
  switch(s)
  {
    case 's1':
      url = 'ws://localhost:8081';
      break;
    case 's2':
      url = 'ws://localhost:8082';
      break;
    default:
      url = 'ws://localhost:8081';
      break;
  }
  var ws = new WebSocket(url);

  var token = null;

  // 登录
  $('#login_button').click(function(){
    ws.send(JSON.stringify({
      action: 'login',
      username: $('#login_username').val(),
      pass: $('#login_password').val()
    }));
  });

  // 注册
  $('#signup_button').click(function(){
    ws.send(JSON.stringify({
      action: 'signup',
      username: $('#username').val(),
      pass: $('#password').val(),
      email: $('#email').val()
    }));
  });

  ws.onmessage = function(evt) { 

    var data = JSON.parse(evt.data);
    if(data) {
      switch(data.action) {
        case 'syspop': // 新系统消息
          popToChat2(data.message);
          break;
        case 'chat1pop': // 公聊新消息
          popToChat1(data.username + ': ' + data.message);
          break;
        case 'chat2pop': // 私聊新消息
          popToChat2(data.username + ': ' + data.message);
          break;
        case 'login.ok': // 登录成功 { username: user.username }
          $('#user').text(data.username);
          popToChat2('登录成功');
          break;
        case 'signup.ok': // 注册成功 { username: user.username }
          $('#user').text(data.username);
          popToChat2('注册成功');
          break;
        case 'enter_hall': // 进入大厅
          document.title = data.title;
          //addToUserlist(data.users);
          break;
      }
    }
  };

  ws.onopen = function(open) {
    console.log(ws);
  };

  ws.onclose = function(close) {
    popToChat1('type:' + close.type 
      + ', wasClean:' + close.wasClean 
      + ', code:' + close.code 
      + ', reason:' + close.reason);
  };

  ws.onerror = function(error) {
    popToChat1('type:' + error.type);
  };

  
});


function popToChat1(message)
{
  popToChat('chat1', message)
}

function popToChat2(message)
{
  popToChat('chat2', message)
}

function popToChat(id, message)
{
  var pre = document.createElement("p");
  pre.style.wordWrap = "break-word";
  pre.innerHTML = message;
  $('#' + id).append(pre);
}

function addToUserlist(users)
{
   $.each(users, function(i, user){
    var pre = document.createElement("span");
    pre.style.paddingLeft = '10px';
    pre.innerHTML = user.who;
    $('#userlist').append(pre);
  });
}

function getParameterByName(name)
{
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.search);
  if(results == null)
    return "";
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}
</script>

<style>
#container{
  width:960px;
}
#userlist{
  width: 250px;
  height: 200px;
}
.left-f{
  float:left;
}
.black-b{
  border: 1px solid #000;
}
.blue-b{
  border: 1px solid #00f;
}
.chat {
  width: 350px;
  height: 200px;
}

</style>
</head>
<body>
  <div id="container">
    <div id="user"></div>

    <div id="chat1" class="chat black-b left-f"></div>
    <div id="chat2" class="chat blue-b left-f"></div>

    <div id="userlist" class="black-b left-f"></div>
    <div id="login">
      <input type="text" id="login_username" />
      <input type="password" id="login_password" />
      <input type="button" id="login_button" value="Sign in" />
    </div>
    <div id="signup">
      <input type="text" id="username" />
      <input type="password" id="password" />
      <input type="text" id="email" />
      <input type="button" id="signup_button" value="Create an account" />
    </div>
  </div>
</body>
</html>
